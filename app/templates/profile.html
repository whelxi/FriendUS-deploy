{% extends "layout.html" %}
{% from "macros.html" import render_tag_selector, render_user_tags %}

{% block content %}
    <div class="p-4 mb-4 bg-light rounded-3 shadow-sm">
        <div class="container-fluid py-4 d-flex align-items-center">
            <div class="me-4 position-relative">
                {% if 'http' in user.image_file %}
                    <img class="rounded-circle account-img" 
                         src="{{ user.image_file }}" 
                         alt="Profile Pic"
                         style="width: 140px; height: 140px; object-fit: cover; border: 4px solid #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                {% else %}
                    <img class="rounded-circle account-img" 
                         src="{{ url_for('static', filename='profile_pics/' + user.image_file) }}" 
                         alt="Profile Pic"
                         style="width: 140px; height: 140px; object-fit: cover; border: 4px solid #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                {% endif %}
            </div>
            
            <div class="flex-grow-1">
                <h1 class="display-5 fw-bold mb-1">{{ user.username }}</h1>
                <p class="text-muted mb-3">{{ user.email }}</p>
                
                {% if user.bio %}
                    <p class="mb-3 fst-italic text-dark border-start border-4 border-primary ps-3 bg-white py-2 rounded">
                        {{ user.bio }}
                    </p>
                {% endif %}

                <div class="mb-2">
                    <small class="text-uppercase text-secondary fw-bold" style="font-size: 0.75rem; letter-spacing: 1px;">Interests</small>
                </div>
                {{ render_user_tags(user.interests) }}
                
                {% if user == current_user %}
                    <div class="mt-3">
                        <button type="button" class="btn btn-outline-dark btn-sm" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                            <i class="bi bi-pencil-fill"></i> Edit Profile
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    {% if user == current_user %}
    <div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editProfileModalLabel">Update Profile</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="" enctype="multipart/form-data">
                    {{ form.hidden_tag() }}
                    <div class="modal-body">
                        <div class="mb-3">
                            {{ form.username.label(class="form-label") }}
                            {{ form.username(class="form-control") }}
                        </div>
                        
                        {% if form.bio %}
                        <div class="mb-3">
                            {{ form.bio.label(class="form-label") }}
                            {{ form.bio(class="form-control", rows=3) }}
                        </div>
                        {% endif %}

                        <div class="mb-3">
                            {{ form.email.label(class="form-label") }}
                            {{ form.email(class="form-control", readonly=True, style="background-color: #e9ecef;") }}
                        </div>
                        <div class="mb-3">
                            {{ form.picture.label(class="form-label") }}
                            {{ form.picture(class="form-control") }}
                        </div>

                        <label class="form-label">Interests</label>
                        {{ render_tag_selector(form.interests, max_selection=5) }}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        {{ form.submit(class="btn btn-primary", value="Save Changes") }}
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}

    <h3 class="mb-4 border-bottom pb-2">Posts by {{ user.username }}</h3>
    
    <div class="row">
        {% for post in posts %}
        <div class="col-md-12 mb-4">
            <div class="card h-100 shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center bg-transparent">
                    <div class="d-flex align-items-center">
                        {% if 'http' in post.author.image_file %}
                            <img class="rounded-circle article-img me-2" src="{{ post.author.image_file }}" style="width: 35px; height: 35px; object-fit: cover;">
                        {% else %}
                            <img class="rounded-circle article-img me-2" src="{{ url_for('static', filename='profile_pics/' + post.author.image_file) }}" style="width: 35px; height: 35px; object-fit: cover;">
                        {% endif %}
                        <a class="fw-bold text-decoration-none text-dark" href="#">{{ post.author.username }}</a>
                    </div>
                    <small class="text-muted">{{ post.timestamp.strftime('%Y-%m-%d %H:%M') }}</small>
                </div>
                
                <div class="card-body">
                    <p class="card-text fs-5">{{ post.body | safe }}</p>
                    
                    {% if post.media_filename %}
                        <img src="{{ url_for('static', filename='uploads/' + post.media_filename) }}" class="img-fluid rounded mt-2 mb-3" style="max-height: 400px; width: auto;">
                    {% endif %}
                    
                    {% if post.tags %}
                        <div class="mt-2">
                            {% for tag in post.tags.split(',') %}
                                <span class="badge rounded-pill bg-light text-dark border me-1">#{{ tag }}</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                <div class="card-footer bg-transparent border-top-0">
                    <small class="text-muted">{{ post.likes|length }} Likes • {{ post.comments.count() }} Comments</small>
                </div>
            </div>
        </div>
        {% else %}
            <div class="alert alert-info text-center">
                <i class="bi bi-info-circle me-2"></i> This user hasn't posted anything yet.
            </div>
        {% endfor %}
    </div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const checkboxes = document.querySelectorAll('.tag-checkbox');
    const MAX_SELECTION = 5;

    checkboxes.forEach(checkbox => {
        updateStyle(checkbox);
        checkbox.addEventListener('change', function() {
            const checkedCount = document.querySelectorAll('.tag-checkbox:checked').length;
            if (this.checked && checkedCount > MAX_SELECTION) {
                this.checked = false;
                alert("Bạn chỉ được chọn tối đa " + MAX_SELECTION + " sở thích!");
                return;
            }
            updateStyle(this);
        });
    });

    function updateStyle(checkbox) {
        const label = document.querySelector(`label[for="${checkbox.id}"]`);
        if (!label) return;
        if (checkbox.checked) {
            label.classList.remove('btn-outline-primary');
            label.classList.add('btn-primary');
        } else {
            label.classList.add('btn-outline-primary');
            label.classList.remove('btn-primary');
        }
    }
});
</script>
{% endblock %}