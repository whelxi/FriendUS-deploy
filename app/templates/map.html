{% extends "layout.html" %}

{% set full_width = True %}

{% block content %}
<style>
    /* --- Base --- */
    body, html { overflow: hidden; } 
    /* [UPDATE] Thêm overflow: hidden để cắt bỏ phần box bị đẩy xuống dưới, làm mất thanh cuộn */
    #map-container { position: relative; width: 100%; height: calc(100vh - 56px); font-family: 'Roboto', 'Segoe UI', sans-serif; overflow: hidden; }
    #map { width: 100%; height: 100%; }

    /* --- Floating Search Bar (State A) --- */
    #floating-search-bar {
        position: absolute; top: 16px; left: 16px; z-index: 1000;
        display: flex; gap: 8px; align-items: center;
        transition: opacity 0.2s ease;
    }
    
    .search-container-pill {
        background: white; border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2), 0 -1px 0px rgba(0,0,0,0.02);
        display: flex; align-items: center;
        width: 392px; height: 48px; padding: 0 12px;
        transition: box-shadow 0.2s;
    }
    .search-container-pill:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.2); }

    .menu-btn { padding: 8px; border: none; background: none; font-size: 20px; color: #5f6368; cursor: pointer; border-radius: 50%; }
    .menu-btn:hover { background: #f1f3f4; }

    .search-input { flex: 1; border: none; outline: none; font-size: 16px; background: transparent; height: 100%; padding-left: 10px; color: #202124; }
    
    .search-btn-grey { border: none; background: none; color: #5f6368; font-size: 20px; cursor: pointer; padding: 8px; border-radius: 50%; }
    .search-btn-grey:hover { background: #f1f3f4; color: #202124; }

    .v-divider { width: 1px; height: 28px; background: #dfe1e5; margin: 0 8px; }

    .direction-icon-btn { border: none; background: none; color: #1a73e8; font-size: 22px; cursor: pointer; padding: 8px; border-radius: 50%; transition: background 0.2s; }
    .direction-icon-btn:hover { background: #e8f0fe; }

    /* --- Sidebar Panel (State B) --- */
    #sidebar-panel {
        position: absolute; top: 0; left: 0; bottom: 0; width: 408px;
        background: white; z-index: 1001;
        box-shadow: 4px 0 12px rgba(0,0,0,0.15);
        transform: translateX(-110%); 
        transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        display: flex; flex-direction: column;
    }
    #sidebar-panel.active { transform: translateX(0); }

    .sidebar-header { background: white; padding: 12px 16px; display: flex; align-items: flex-start; gap: 10px; flex-shrink: 0; }

    .close-sidebar-btn { background: transparent; border: none; color: #5f6368; font-size: 22px; cursor: pointer; padding: 8px; border-radius: 50%; margin-top: 4px; }
    .close-sidebar-btn:hover { background: #f1f3f4; }

    .route-inputs-container { flex: 1; display: flex; flex-direction: column; gap: 8px; }
    
    .input-row { background: #f1f3f4; border-radius: 8px; height: 40px; display: flex; align-items: center; padding: 0 12px; border: 1px solid transparent; }
    .input-row:focus-within { background: white; border-color: #dadce0; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    .input-row input { border: none; background: transparent; outline: none; width: 100%; font-size: 14px; }

    .mode-selector { display: flex; justify-content: space-between; padding: 8px 16px; border-bottom: 1px solid #e8eaed; flex-shrink: 0; }
    .mode-btn { flex: 1; border: none; background: none; padding: 6px; border-radius: 20px; color: #5f6368; cursor: pointer; display: flex; justify-content: center; }
    .mode-btn.active { background: #e8f0fe; color: #1967d2; font-weight: 500; }

    /* --- Route Instructions List --- */
    #route-panel-content {
        flex: 1; overflow-y: auto; padding: 0;
    }
    .instruction-step {
        padding: 12px 16px;
        border-bottom: 1px solid #f1f3f4;
        display: flex; gap: 12px; align-items: flex-start;
    }
    .instruction-step:hover { background: #f8f9fa; }
    .step-icon { color: #5f6368; font-size: 20px; margin-top: -2px; }
    .step-text { font-size: 14px; color: #202124; line-height: 1.4; }
    .step-dist { font-size: 12px; color: #70757a; margin-top: 2px; }
    
    .route-summary { padding: 16px; background: #f8f9fa; border-bottom: 1px solid #e8eaed; }
    .summary-time { font-size: 24px; color: #188038; font-weight: 500; }
    .summary-dist { color: #5f6368; font-size: 15px; margin-left: 8px; }

    /* --- Bottom Info Card --- */
    #bottom-card {
        position: absolute; bottom: 24px; left: 50%; transform: translate(-50%, 150%);
        width: 95%; max-width: 400px;
        background: white; border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.18);
        padding: 16px 20px; z-index: 999;
        display: flex; align-items: center; justify-content: space-between;
        transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }
    #bottom-card.visible { transform: translate(-50%, 0); }
    
    .card-content { flex: 1; margin-right: 12px; }
    .card-title { font-size: 16px; font-weight: 600; color: #202124; display: block; margin-bottom: 4px; }
    .card-sub { font-size: 13px; color: #5f6368; line-height: 1.4; display: block; }
    
    .circle-btn {
        width: 40px; height: 40px; border-radius: 50%;
        background: #1a73e8; color: white; border: none; font-size: 20px;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; transition: background 0.1s;
    }
    .circle-btn:hover { background: #174ea6; }

    /* --- Search Results --- */
    #search-results {
        position: absolute; top: 70px; left: 16px; width: 392px;
        background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        max-height: 80vh; overflow-y: auto; display: none; z-index: 1002;
    }
    .result-item { padding: 12px 16px; border-bottom: 1px solid #f1f3f4; cursor: pointer; display: flex; gap: 12px; align-items: center; }
    .result-item:hover { background: #f8f9fa; }
    .result-icon { color: #5f6368; font-size: 18px; }
    .result-name { font-weight: 500; font-size: 14px; color: #202124; }
    .result-addr { font-size: 13px; color: #70757a; }

    /* [NEW] User Location Marker (Blue Dot) */
    .user-marker-dot {
        width: 16px; height: 16px;
        background-color: #4285F4;
        border: 2px solid white;
        border-radius: 50%;
        box-shadow: 0 0 0 10px rgba(66, 133, 244, 0.2); /* Blue halo */
    }
</style>

<div id="map-container">
    
    <div id="floating-search-bar">
        <div class="search-container-pill">
            <input type="text" id="main-search-input" class="search-input" placeholder="Search VietMap..." autocomplete="off">
            <button class="search-btn-grey" id="btn-trigger-search" title="Search"><i class="bi bi-search"></i></button>
            <div class="v-divider"></div>
            <button class="direction-icon-btn" id="btn-open-routes" title="Directions"><i class="bi bi-cursor-fill"></i></button>
        </div>
    </div>

    <div id="sidebar-panel">
        <div class="sidebar-header">
            <button class="close-sidebar-btn" id="btn-close-sidebar"><i class="bi bi-arrow-left"></i></button>
            <div class="route-inputs-container">
                <div class="input-row">
                    <i class="bi bi-circle" style="font-size: 12px; margin-right: 10px; color: #5f6368;"></i>
                    <input type="text" id="input-start" placeholder="Choose starting point" autocomplete="off">
                </div>
                <div class="input-row">
                    <i class="bi bi-geo-alt-fill" style="font-size: 16px; margin-right: 10px; color: #ea4335;"></i>
                    <input type="text" id="input-end" placeholder="Choose destination" autocomplete="off">
                </div>
            </div>
        </div>

        <div class="mode-selector">
            <button class="mode-btn active" data-mode="car" title="Driving"><i class="bi bi-car-front-fill"></i></button>
            <button class="mode-btn" data-mode="motorcycle" title="Motorcycle"><i class="bi bi-bicycle" style="font-weight:bold;"></i></button>
            <button class="mode-btn" data-mode="foot" title="Walking"><i class="bi bi-person-walking"></i></button>
            <button class="mode-btn" data-mode="bike" title="Cycling"><i class="bi bi-bicycle"></i></button>
        </div>

        <div id="route-panel-content">
            <div style="padding: 30px; text-align: center; color: #70757a;">
                <i class="bi bi-map" style="font-size: 40px; color: #dfe1e5;"></i>
                <p style="margin-top: 10px;">Select a destination to view route.</p>
            </div>
        </div>
    </div>

    <div id="bottom-card">
        <div class="card-content">
            <span class="card-title" id="info-name">Selected Location</span>
            <span class="card-sub" id="info-addr">Fetching address...</span>
        </div>
        <div class="card-actions">
            <button class="circle-btn" id="btn-card-directions" title="Directions to here">
                <i class="bi bi-cursor-fill"></i>
            </button>
        </div>
    </div>

    <div id="search-results"></div>
    <div id="map"></div>
</div>

<script id="map-config" type="application/json">
{
    "apiKey": "{{ vietmap_api_key }}",
    "savedLocations": {{ locations_data | tojson }},
    "urls": { 
        "search": "{{ url_for('map.api_search') }}", 
        "detail": "{{ url_for('map.api_detail') }}",
        "reverse": "{{ url_for('map.api_reverse') }}",
        "route": "{{ url_for('map.api_route') }}",
        "create": "{{ url_for('map.create_location_on_click') }}" 
    }
}
</script>
{% endblock %}
{% block scripts %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
    /* Fix cho icon mặc định của Leaflet đôi khi bị lỗi đường dẫn */
    .leaflet-default-icon-path { background-image: url(https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png); }
</style>

<script>
class MapManager {
    constructor() {
        this.config = JSON.parse(document.getElementById('map-config').textContent);
        this.map = null;
        this.layers = { route: null, markers: [] };
        
        this.searchTimeout = null;
        this.transportMode = 'car';
        this.activeInput = 'main'; 
        this.locations = { start: null, end: null };
        this.currentSelection = null;
        this.userLocation = null; // Lưu vị trí user để dùng lại

        this.dom = {
            searchBar: document.getElementById('floating-search-bar'),
            sidebar: document.getElementById('sidebar-panel'),
            bottomCard: document.getElementById('bottom-card'),
            results: document.getElementById('search-results'),
            routePanel: document.getElementById('route-panel-content'),
            inputs: {
                main: document.getElementById('main-search-input'),
                start: document.getElementById('input-start'),
                end: document.getElementById('input-end')
            },
            infoName: document.getElementById('info-name'),
            infoAddr: document.getElementById('info-addr'),
            btnCardRoute: document.getElementById('btn-card-directions')
        };

        this.init();
    }

    init() {
        // [OSM] Init Map
        this.map = L.map('map', { zoomControl: false }).setView([10.762622, 106.660172], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19, attribution: '© OpenStreetMap'
        }).addTo(this.map);
        L.control.zoom({ position: 'bottomright' }).addTo(this.map);

        // Lấy vị trí user ngay khi vào web (silent) để sẵn sàng dùng
        this.preloadUserLocation();

        this.setupListeners();
        this.map.on('click', (e) => this.handleMapClick(e));
    }

    preloadUserLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                this.userLocation = { 
                    lat: pos.coords.latitude, 
                    lon: pos.coords.longitude, 
                    name: "Your Location", 
                    isUser: true 
                };
                // Vẽ chấm xanh vị trí hiện tại
                L.circleMarker([this.userLocation.lat, this.userLocation.lon], {
                    radius: 8, fillColor: "#4285F4", color: "#fff", weight: 2, opacity: 1, fillOpacity: 1
                }).addTo(this.map);
            }, err => console.log("Geo permission denied"));
        }
    }

    setupListeners() {
        document.getElementById('btn-open-routes').onclick = () => this.setMode('route');
        document.getElementById('btn-close-sidebar').onclick = () => this.setMode('search');

        // Nút chỉ đường từ thẻ thông tin địa điểm
        this.dom.btnCardRoute.onclick = () => {
            if (this.currentSelection) {
                this.setMode('route');
                // Đích đến là địa điểm đang chọn
                this.selectLocation(this.currentSelection, 'end');
                // Focus vào ô "Điểm đi" và hiện gợi ý ngay
                this.dom.inputs.start.focus();
            }
        };

        ['main', 'start', 'end'].forEach(key => {
            const input = this.dom.inputs[key];
            
            // [FIX] Sự kiện Focus: Hiện ngay Your Location nếu ô trống
            input.addEventListener('focus', () => {
                this.activeInput = key;
                if (input.value.trim() === '') {
                    this.renderDefaultSuggestions(); 
                }
            });

            input.addEventListener('input', () => {
                if (input.value.trim() === '') {
                    this.renderDefaultSuggestions();
                } else {
                    clearTimeout(this.searchTimeout);
                    this.searchTimeout = setTimeout(() => this.performSearch(input.value), 400);
                }
            });
        });

        document.getElementById('btn-trigger-search').onclick = () => this.performSearch(this.dom.inputs.main.value);

        // Nút chọn phương tiện
        const modeBtns = document.querySelectorAll('.mode-btn');
        modeBtns.forEach(btn => {
            btn.onclick = () => {
                modeBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                this.transportMode = btn.getAttribute('data-mode');
                if (this.locations.start && this.locations.end) this.calculateRoute();
            };
        });
    }

    // [FIX] Hàm hiển thị gợi ý mặc định (Your Location)
    renderDefaultSuggestions() {
        this.dom.results.innerHTML = '';
        this.dom.results.style.display = 'block';

        const myLoc = document.createElement('div');
        myLoc.className = 'result-item';
        // Style đặc biệt cho Your Location
        myLoc.innerHTML = `
            <div style="background: #e8f0fe; padding: 8px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                <i class="bi bi-cursor-fill" style="color:#1a73e8; font-size: 16px;"></i>
            </div>
            <span class="result-name" style="color: #1a73e8; font-weight: 500;">Your Location</span>`;
        
        myLoc.onclick = () => {
            if (this.userLocation) {
                this.selectLocation(this.userLocation, this.activeInput);
            } else {
                // Nếu chưa có vị trí (do chưa cấp quyền), hỏi lại
                this.getUserLocation().then(loc => {
                    this.userLocation = loc;
                    this.selectLocation(loc, this.activeInput);
                });
            }
        };
        this.dom.results.appendChild(myLoc);
    }

    async handleMapClick(e) {
        if (this.mode === 'route') return;
        const { lat, lng } = e.latlng;
        this.showBottomCard(lat, lng, "Dropped Pin", "Fetching...");
        
        try {
            const res = await fetch(`${this.config.urls.reverse}?lat=${lat}&lon=${lng}`);
            const data = await res.json();
            const addr = data.display_name || "Unknown address";
            const name = addr.split(',')[0];
            this.showBottomCard(lat, lng, name, addr);
        } catch (err) { console.error(err); }
    }

    showBottomCard(lat, lng, name, addr) {
        this.currentSelection = { lat, lon: lng, name };
        this.clearMarkers('search');
        
        const marker = L.marker([lat, lng]).addTo(this.map);
        this.layers.markers.push({ type: 'search', obj: marker });

        this.map.flyTo([lat, lng], 16);
        this.dom.infoName.innerText = name;
        this.dom.infoAddr.innerText = addr;
        this.dom.bottomCard.classList.add('visible');
        this.dom.results.style.display = 'none';
    }

    setMode(mode) {
        this.mode = mode;
        if (mode === 'route') {
            this.dom.searchBar.style.opacity = '0'; 
            this.dom.searchBar.style.pointerEvents = 'none'; 
            this.dom.bottomCard.classList.remove('visible'); 
            this.dom.sidebar.classList.add('active');
            
            // Nếu đã chọn 1 điểm ở search bar, tự điền vào điểm đến
            if (this.dom.inputs.main.value && !this.locations.end) {
                // Logic: Copy từ main sang end
                // Cần copy cả object location chứ không chỉ text
                if (this.currentSelection) {
                    this.selectLocation(this.currentSelection, 'end');
                }
            }
        } else {
            this.dom.searchBar.style.opacity = '1';
            this.dom.searchBar.style.pointerEvents = 'auto';
            this.dom.sidebar.classList.remove('active');
            this.clearRoute();
        }
    }

    async getUserLocation() {
        return new Promise((resolve, reject) => {
            if (!navigator.geolocation) { alert("Geo not supported"); return reject(); }
            navigator.geolocation.getCurrentPosition(
                pos => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude, name: "Your Location", isUser: true }),
                err => { alert("Cannot get location"); reject(err); }, 
                { enableHighAccuracy: true }
            );
        });
    }

    async performSearch(query) {
        if (!query || query.length < 2) { this.dom.results.style.display = 'none'; return; }
        try {
            const res = await fetch(`${this.config.urls.search}?query=${encodeURIComponent(query)}`);
            const data = await res.json();
            this.renderResults(data);
        } catch (e) { console.error(e); }
    }

    renderResults(data) {
        this.dom.results.innerHTML = '';
        this.dom.results.style.display = 'block';

        // Luôn hiện Your Location ở đầu danh sách tìm kiếm
        const myLoc = document.createElement('div');
        myLoc.className = 'result-item';
        myLoc.innerHTML = '<i class="bi bi-cursor-fill result-icon" style="color:#1a73e8"></i> <span class="result-name">Your Location</span>';
        myLoc.onclick = () => {
            if (this.userLocation) this.selectLocation(this.userLocation, this.activeInput);
            else this.getUserLocation().then(loc => this.selectLocation(loc, this.activeInput));
        };
        this.dom.results.appendChild(myLoc);

        data.forEach(place => {
            const item = document.createElement('div');
            item.className = 'result-item';
            const displayName = place.display_name;
            const namePart = displayName.split(',')[0];
            
            item.innerHTML = `
                <i class="bi bi-geo-alt result-icon"></i>
                <div class="result-text">
                    <span class="result-name">${namePart}</span>
                    <span class="result-addr" style="font-size:11px; display:block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:300px;">${displayName}</span>
                </div>`;
            
            item.onclick = () => {
                const loc = { lat: parseFloat(place.lat), lon: parseFloat(place.lon), name: namePart };
                if (this.activeInput === 'main') {
                    this.showBottomCard(loc.lat, loc.lon, loc.name, displayName);
                    this.dom.inputs.main.value = loc.name;
                } else {
                    this.selectLocation(loc, this.activeInput);
                }
            };
            this.dom.results.appendChild(item);
        });
    }

    selectLocation(loc, inputType) {
        this.dom.results.style.display = 'none';
        this.dom.inputs[inputType].value = loc.name;
        this.locations[inputType] = loc;

        if (!loc.isUser) {
            this.clearMarkers(inputType);
            const marker = L.marker([loc.lat, loc.lon]).addTo(this.map);
            this.layers.markers.push({ type: inputType, obj: marker });
        }
        
        if (this.locations.start && this.locations.end) {
            this.calculateRoute();
        }
    }
    
    clearMarkers(type) {
        this.layers.markers = this.layers.markers.filter(m => {
            if (m.type === type) { this.map.removeLayer(m.obj); return false; }
            return true;
        });
    }

    async calculateRoute() {
        const p1 = `${this.locations.start.lat},${this.locations.start.lon}`;
        const p2 = `${this.locations.end.lat},${this.locations.end.lon}`;
        
        this.dom.routePanel.innerHTML = '<div class="p-4 text-center text-muted">Calculating route...</div>';

        try {
            const url = `${this.config.urls.route}?point1=${p1}&point2=${p2}&vehicle=${this.transportMode}`;
            const res = await fetch(url);
            const data = await res.json();

            if (data.routes && data.routes[0]) {
                const route = data.routes[0];
                // [FIX] Sử dụng geometry trả về từ OSRM (đã được backend xin format GeoJSON)
                this.drawRoute(route.geometry); 
                this.renderInstructions(route);
                
                const bounds = L.geoJSON(route.geometry).getBounds();
                this.map.fitBounds(bounds, { padding: [50, 50] });
            } else {
                this.dom.routePanel.innerHTML = '<div class="p-4 text-danger">No route found.</div>';
            }
        } catch (e) {
            console.error(e);
            this.dom.routePanel.innerHTML = '<div class="p-4 text-danger">Error calculating route.</div>';
        }
    }

    renderInstructions(route) {
        const dist = (route.distance / 1000).toFixed(1); 
        const time = Math.round(route.duration / 60); 

        let html = `
            <div class="route-summary">
                <span class="summary-time">${time} min</span>
                <span class="summary-dist">(${dist} km)</span>
            </div>`;
        
        if (route.legs && route.legs[0].steps) {
            route.legs[0].steps.forEach(step => {
                // Tinh chỉnh text hướng dẫn
                let text = step.maneuver.type || 'continue';
                if (step.maneuver.modifier) text += ` ${step.maneuver.modifier}`;
                if (step.name) text += ` on ${step.name}`;
                
                html += `
                    <div class="instruction-step">
                        <i class="bi bi-arrow-right step-icon"></i>
                        <div style="flex:1">
                            <div class="step-text" style="text-transform: capitalize;">${text.replace(/_/g, ' ')}</div>
                            <div class="step-dist">${step.distance.toFixed(0)}m</div>
                        </div>
                    </div>`;
            });
        }
        this.dom.routePanel.innerHTML = html;
    }

    drawRoute(geometry) {
        if (this.layers.route) this.map.removeLayer(this.layers.route);
        // OSRM trả về geometry GeoJSON, Leaflet vẽ trực tiếp được
        this.layers.route = L.geoJSON(geometry, {
            style: { color: '#1a73e8', weight: 6, opacity: 0.8 }
        }).addTo(this.map);
    }

    clearRoute() {
        if (this.layers.route) {
            this.map.removeLayer(this.layers.route);
            this.layers.route = null;
        }
        this.clearMarkers('start');
        this.clearMarkers('end');
        this.locations = { start: null, end: null };
        this.dom.inputs.start.value = '';
        this.dom.inputs.end.value = '';
        this.dom.routePanel.innerHTML = '<div style="padding: 30px; text-align: center; color: #70757a;"><i class="bi bi-map" style="font-size: 40px; color: #dfe1e5;"></i><p style="margin-top: 10px;">Select a destination to view route.</p></div>';
    }
}

document.addEventListener('DOMContentLoaded', () => new MapManager());
</script>
{% endblock %}